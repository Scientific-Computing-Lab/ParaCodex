Copied the original `mg.c` into `data/src/mg-omp/` and wrote the requested loop classification/analysis to `data/src/mg-omp/analysis.md`, covering the main iteration driver, multigrid stage loops, stencil kernels, reductions, halos, RNG/setup paths, and data/array characteristics.

No tests run.

OpenAI Codex v0.65.0 (research preview)
--------
workdir: /root/codex_baseline/serial_omp_nas_workdir
model: gpt-5.1-codex-max
provider: openai
approval: never
sandbox: danger-full-access
reasoning effort: low
reasoning summaries: auto
session id: 019af9a4-3603-78d1-8068-0f1a620c68fe
--------
user
# Loop Classification for GPU Offload - Analysis Phase

## Task
Analyze loops in `/root/codex_baseline/serial_omp_nas_workdir/golden_labels/src/mg-serial/` and produce `/root/codex_baseline/serial_omp_nas_workdir/data/src/mg-omp/analysis.md`. Copy source files unmodified to `/root/codex_baseline/serial_omp_nas_workdir/data/src/mg-omp/`.

**Files:** - mg.c  
**Reference:** Check Makefile in `/root/codex_baseline/serial_omp_nas_workdir/data/src/mg-omp/` (do not modify)

## Process

### 0. COPY THE SOURCE FILES - - mg.c TO THE KERNEL DIRECTORY /root/codex_baseline/serial_omp_nas_workdir/data/src/mg-omp

### 1. Find All Loops
```bash
# Find main compute loop
grep -n "for.*iter\|for.*it\|while\|main(" *.c *.cpp 2>/dev/null | head -50

# List all loop-containing functions
grep -n "for\s*(" *.c *.cpp 2>/dev/null | head -100
```

Prioritize functions called in main compute loop:
- Every iteration → CRITICAL/IMPORTANT
- Once at setup → SECONDARY/AVOID

### 2. Classify Priority
For each loop: `iterations × ops/iter = total work`

- **CRITICAL:** >50% runtime OR called every iteration with O(N) work
- **IMPORTANT:** 5-50% runtime OR called every iteration with small work
- **SECONDARY:** Called once at setup
- **AVOID:** Setup/IO/RNG OR <10K iterations

### 3. Determine Loop Type (Decision Tree)

```
Q0: Nested inside another loop? → Note parent
Q1: Writes A[idx[i]] with varying idx? → Type D (Histogram)
Q2: Reads A[i-1] or accumulates across iterations? → Type E (Recurrence - CPU only)
Q3: Stage loop where L+1 depends on L?
    - Scratch swap (tmp1↔tmp2)? → C1 (FFT/Butterfly)
    - Level traversal with stencil calls? → C2 (Multigrid)
Q4: Inner bound varies with outer index? → Type B (Sparse)
Q5: Accumulates to scalar? → Type F (Reduction)
Q6: Accesses neighbors? → Type G (Stencil)
Default → Type A (Dense)
```

**Special Case - Outer A + Inner E:**
- Outer timed loop with per-iteration RNG → Outer is Type A (CRITICAL), inner is Type E
- Mark "RNG in timed loop: YES" only if RNG runs inside main timer

### 4. Type Reference

| Type | Pattern | Parallelizable |
|------|---------|----------------|
| A | Dense, constant bounds | YES |
| B | Sparse (CSR), inner bound varies | Outer only |
| C1 | FFT/Butterfly, scratch swap | Outer only |
| C2 | Multigrid, hierarchical calls | Outer only |
| D | Histogram, indirect write | YES + atomic |
| E | Recurrence, loop-carried dep | NO |
| F | Reduction to scalar | YES + reduction |
| G | Stencil, neighbor access | YES |

### 5. Data Analysis
For each array:
- Definition: flat vs pointer-to-pointer
- Allocation: static vs dynamic
- Struct members accessed?
- Global variables used?

### 6. Flag Issues
- Variable bounds
- Reduction needed
- Atomic required
- Stage dependency
- RNG in loop
- <10K iterations

## Output: analysis.md

### Loop Nesting Structure
```
- outer_loop (line:X) Type A
  └── inner_loop_1 (line:Y) Type E
- standalone_loop (line:Z) Type A
```

### Loop Details
For each CRITICAL/IMPORTANT/SECONDARY loop:
```
## Loop: [function] at [file:line]
- **Iterations:** [count]
- **Type:** [A-H] - [reason]
- **Parent loop:** [none / line:X]
- **Contains:** [inner loops or none]
- **Dependencies:** [none / reduction:vars / stage / recurrence]
- **Nested bounds:** [constant / variable]
- **Private vars:** [list]
- **Arrays:** [name(R/W/RW)]
- **Issues:** [flags]
```

### Summary Table
| Function | Type | Priority | Parent | Iterations | Dependencies | Issues |
|----------|------|----------|--------|------------|--------------|--------|

### Data Details
- **Dominant compute loop:** [main timed loop]
- **Arrays swapped between functions?:** YES/NO
- **Scratch arrays?:** YES/NO
- **Mid-computation sync?:** YES/NO
- **RNG in timed loop?:** YES/NO (only if inside timer)

## Constraints
- Find all loops in functions called from main compute loop
- Document only - no pragmas or code modifications
- When uncertain between B and C, choose C
- Copy all source files unmodified to `/root/codex_baseline/serial_omp_nas_workdir/data/src/mg-omp/`

mcp startup: no servers
exec
/bin/bash -lc ls in /root/codex_baseline/serial_omp_nas_workdir succeeded in 8ms:
AGENTS.md
data
gate_sdk
golden_labels
npb3.3.1.tar.gz
system_info.txt
test_all_nas_kernels.sh
exec
/bin/bash -lc 'cat system_info.txt' in /root/codex_baseline/serial_omp_nas_workdir succeeded in 8ms:
=== SYSTEM BASELINE ===
Linux ErelPC 6.6.87.2-microsoft-standard-WSL2 #1 SMP PREEMPT_DYNAMIC Thu Jun  5 18:30:46 UTC 2025 x86_64 x86_64 x86_64 GNU/Linux
PRETTY_NAME="Ubuntu 22.04.3 LTS"
NAME="Ubuntu"
VERSION_ID="22.04"
VERSION="22.04.3 LTS (Jammy Jellyfish)"
VERSION_CODENAME=jammy
ID=ubuntu
ID_LIKE=debian
HOME_URL="https://www.ubuntu.com/"
SUPPORT_URL="https://help.ubuntu.com/"
BUG_REPORT_URL="https://bugs.launchpad.net/ubuntu/"
PRIVACY_POLICY_URL="https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"
UBUNTU_CODENAME=jammy
ldd (Ubuntu GLIBC 2.35-0ubuntu3.11) 2.35

=== FIRMWARE & MICROCODE ===
# dmidecode 3.3
Scanning /dev/mem for entry point.
# No SMBIOS nor DMI entry point found, sorry.

thinking
**Preparing to copy source file**

I'm planning to check the needed directories first, then copy the source file mg.c to the data path as instructed.
exec
/bin/bash -lc 'ls golden_labels/src/mg-serial' in /root/codex_baseline/serial_omp_nas_workdir succeeded in 8ms:
Makefile
README
common
common copy
config
globals.h
mg.c
mg.config
mg.llvm
sys

thinking
**Preparing to move source file**

Planning to copy the mg.c file into data/src/mg-omp and verifying the destination path.
exec
/bin/bash -lc 'ls data/src/mg-omp' in /root/codex_baseline/serial_omp_nas_workdir succeeded in 10ms:
Makefile
README
common
common copy
config
globals.h
mg.config
sys

thinking
**Planning file copy**

I'm preparing to copy the unmodified mg.c file to the data path using the cp command.
exec
/bin/bash -lc 'cp golden_labels/src/mg-serial/mg.c data/src/mg-omp/' in /root/codex_baseline/serial_omp_nas_workdir succeeded in 14ms:


thinking
**Preparing to analyze loops in mg.c**

Planning to run the provided grep/find loops commands from the golden directory on mg.c to examine loop structures as instructed, deciding to skip a separate plan since analysis is small but complex.
exec
/bin/bash -lc "cd golden_labels/src/mg-serial && grep -n \"for.*iter\\|for.*it\\|while\\|main(\" *.c *.cpp 2>/dev/null | head -50" in /root/codex_baseline/serial_omp_nas_workdir succeeded in 8ms:
mg.c:49:int main()
mg.c:66:  for (i = T_init; i < T_last; i++) {
mg.c:94:    while (fgetc(fp) != '\n');
mg.c:96:    while (fgetc(fp) != '\n');
mg.c:98:    while (fgetc(fp) != '\n');
mg.c:195:  for (it = 1; it <= nit; it++) {
mg.c:1173:  while (nj != 0) {

thinking
**Listing commands**
exec
/bin/bash -lc "cd golden_labels/src/mg-serial && grep -n \"for\\s*(\" *.c *.cpp 2>/dev/null | head -100" in /root/codex_baseline/serial_omp_nas_workdir succeeded in 10ms:
mg.c:66:  for (i = T_init; i < T_last; i++) {
mg.c:99:    for (i = 0; i <= 7; i++) {
mg.c:111:    for (i = 0; i <= 7; i++) {
mg.c:184:  for (i = T_bench; i < T_last; i++) {
mg.c:195:  for (it = 1; it <= nit; it++) {
mg.c:271:    for (i = T_bench; i < T_last; i++) {
mg.c:294:  for (k = lt-1; k >= 1; k--) {
mg.c:295:    for (ax = 0; ax < 3; ax++) {
mg.c:299:  for (k = lt; k >= 1; k--) {
mg.c:305:  for (k = lt; k >= 1; k--) {
mg.c:306:    for (ax = 0; ax < 3; ax++) {
mg.c:327:  for (j = lt-1; j >= 1; j--) {
mg.c:344:  for (k = lt; k >= lb+1; k--) {
mg.c:355:  for (k = lb+1; k <= lt-1; k++) {
mg.c:389:  for (i3 = 1; i3 < n3-1; i3++) {
mg.c:390:    for (i2 = 1; i2 < n2-1; i2++) {
mg.c:391:      for (i1 = 0; i1 < n1; i1++) {
mg.c:401:  for (i3 = 1; i3 < n3-1; i3++) {
mg.c:402:    for (i2 = 1; i2 < n2-1; i2++) {
mg.c:403:      for (i1 = 1; i1 < n1-1; i1++) {

thinking
**Exploring function definitions**

Planning to analyze function boundaries and loops in mg.c by examining the file head, considering tools like sed, rg, ctags, and grep to identify function names and structures efficiently.
exec
/bin/bash -lc "cd golden_labels/src/mg-serial && sed -n '1,260p' mg.c" in /root/codex_baseline/serial_omp_nas_workdir succeeded in 12ms:

#ifdef __PGIC__
#undef __GNUC__
#else
#define num_workers(a)
#endif

#include <stdio.h>
#include <stdlib.h>
#include <math.h>

#include "globals.h"

#include "timers.h"
#include "print_results.h"

#define I3D(array,n1,n2,i3,i2,i1) (array[(i3)*n2*n1 + (i2)*n1 + (i1)])

static void setup(int *n1, int *n2, int *n3);
static void mg3P(double u[], double v[], double r[],
exec
/bin/bash -lc "cd golden_labels/src/mg-serial && sed -n '260,520p' mg.c" in /root/codex_baseline/serial_omp_nas_workdir succeeded in 9ms:
  print_results("MG", Class, nx[lt], ny[lt], nz[lt], 
                nit, t,
                mflops, "          floating point", 
                verified, NPBVERSION, COMPILETIME,
                CS1, CS2, CS3, CS4, CS5, CS6, CS7);

  if (timeron) {
    tmax = timer_read(T_bench);
    if (tmax == 0.0) tmax = 1.0;

    printf("  SECTION   Time (secs)\n");
    for (i = T_bench; i < T_last; i++) {
      t = timer_read(i);
      if (i == T_resid2) {
        t = timer_read(T_resid) - t;
        printf("    --> %8s:%9.3f  (%6.2f%%)\n", "mg-resid", t, t*100./tmax);
      } else {
        printf("  %-8s:%9.3f  (%6.2f%%)\n", t_names[i], t, t*100./tmax);
      }
    }
exec
/bin/bash -lc "cd golden_labels/src/mg-serial && sed -n '520,1040p' mg.c" in /root/codex_baseline/serial_omp_nas_workdir succeeded in 13ms:
  	y1 = (double*)acc_malloc(m3k*m2k*m1k*sizeof(double));
  #else
  	x1 = (double*)malloc(m3k*m2k*m1k*sizeof(double));
  	y1 = (double*)malloc(m3k*m2k*m1k*sizeof(double));
  #endif

  if (timeron) timer_start(T_rprj3);
  if (m1k == 3) {
    d1 = 2;
  } else {
    d1 = 1;
  }

  if (m2k == 3) {
    d2 = 2;
  } else {
    d2 = 1;
  }

  if (m3k == 3) {
exec
/bin/bash -lc "cd golden_labels/src/mg-serial && sed -n '1040,1560p' mg.c" in /root/codex_baseline/serial_omp_nas_workdir succeeded in 13ms:
    j2[i][1] = 0;
    j3[i][1] = 0;
    ten[i][0] = 1.0;
    j1[i][0] = 0;
    j2[i][0] = 0;
    j3[i][0] = 0;
  }
  
  for (i3 = 1; i3 < n3-1; i3++) {
    for (i2 = 1; i2 < n2-1; i2++) {
      for (i1 = 1; i1 < n1-1; i1++) {
        
		if(I3D(oz, n1, n2, i3, i2, i1) > ten[0][1]){
          
          ten[0][1] = I3D(oz, n1, n2, i3, i2, i1);
          j1[0][1] = i1;
          j2[0][1] = i2;
          j3[0][1] = i3;
          bubble(ten, j1, j2, j3, mm, 1);
        }

thinking
**Mapping loops and arrays in mg.c for analysis**

I'm focusing on identifying and classifying loops inside functions called within the main timed iteration loop, locating global/static array definitions and access types, and preparing line-numbered details for accurate referencing in the analysis report.
exec
/bin/bash -lc "cd golden_labels/src/mg-serial && nl -ba mg.c | sed -n '1,260p'" in /root/codex_baseline/serial_omp_nas_workdir succeeded in 22ms:
     1	
     2	#ifdef __PGIC__
     3	#undef __GNUC__
     4	#else
     5	#define num_workers(a)
     6	#endif
     7	
     8	#include <stdio.h>
     9	#include <stdlib.h>
    10	#include <math.h>
    11	
    12	#include "globals.h"
    13	
    14	#include "timers.h"
    15	#include "print_results.h"
    16	
    17	#define I3D(array,n1,n2,i3,i2,i1) (array[(i3)*n2*n1 + (i2)*n1 + (i1)])
    18	
    19	static void setup(int *n1, int *n2, int *n3);
    20	static void mg3P(double u[], double v[], double r[],

thinking
**Planning line number tracking**

I'm deciding to add line number tracking to other functions, using `nl` to identify key loop sections for easier navigation.
exec
/bin/bash -lc "cd golden_labels/src/mg-serial && nl -ba mg.c | sed -n '260,640p'" in /root/codex_baseline/serial_omp_nas_workdir succeeded in 9ms:
   260	  print_results("MG", Class, nx[lt], ny[lt], nz[lt], 
   261	                nit, t,
   262	                mflops, "          floating point", 
   263	                verified, NPBVERSION, COMPILETIME,
   264	                CS1, CS2, CS3, CS4, CS5, CS6, CS7);
   265	
   266	  if (timeron) {
   267	    tmax = timer_read(T_bench);
   268	    if (tmax == 0.0) tmax = 1.0;
   269	
   270	    printf("  SECTION   Time (secs)\n");
   271	    for (i = T_bench; i < T_last; i++) {
   272	      t = timer_read(i);
   273	      if (i == T_resid2) {
   274	        t = timer_read(T_resid) - t;
   275	        printf("    --> %8s:%9.3f  (%6.2f%%)\n", "mg-resid", t, t*100./tmax);
   276	      } else {
   277	        printf("  %-8s:%9.3f  (%6.2f%%)\n", t_names[i], t, t*100./tmax);
   278	      }
   279	    }
exec
/bin/bash -lc "cd golden_labels/src/mg-serial && nl -ba mg.c | sed -n '640,1040p'" in /root/codex_baseline/serial_omp_nas_workdir succeeded in 15ms:
   640			  I3D(z3, mm1, mm2, i3, i2, i1) = I3D(oz, mm1, mm2, i3+1, i2+1, i1) 
   641			  								+ I3D(oz, mm1, mm2, i3+1, i2, i1)
   642											+ I3D(z1, mm1, mm2, i3, i2, i1);
   643	
   644	        }
   645	      }
   646	    }
   647	    for (i3 = 0; i3 < mm3-1; i3++) {
   648	      for (i2 = 0; i2 < mm2-1; i2++) {
   649	        for (i1 = 0; i1 < mm1-1; i1++) {
   650			
   651			  I3D(ou, n1, n2, 2*i3, 2*i2, 2*i1)   = I3D(ou, n1, n2, 2*i3, 2*i2, 2*i1)
   652			  									  + I3D(oz, mm1, mm2, i3, i2, i1);
   653			  I3D(ou, n1, n2, 2*i3, 2*i2, 2*i1+1) = I3D(ou, n1, n2, 2*i3, 2*i2, 2*i1+1)
   654			  									  + 0.5*(I3D(oz, mm1, mm2, i3, i2, i1+1)
   655												       + I3D(oz, mm1, mm2, i3, i2, i1));
   656	        }
   657	      }
   658	    }
   659	
exec
/bin/bash -lc "cd golden_labels/src/mg-serial && nl -ba mg.c | sed -n '1040,1480p'" in /root/codex_baseline/serial_omp_nas_workdir succeeded in 8ms:
  1040	    j2[i][1] = 0;
  1041	    j3[i][1] = 0;
  1042	    ten[i][0] = 1.0;
  1043	    j1[i][0] = 0;
  1044	    j2[i][0] = 0;
  1045	    j3[i][0] = 0;
  1046	  }
  1047	  
  1048	  for (i3 = 1; i3 < n3-1; i3++) {
  1049	    for (i2 = 1; i2 < n2-1; i2++) {
  1050	      for (i1 = 1; i1 < n1-1; i1++) {
  1051	        
  1052			if(I3D(oz, n1, n2, i3, i2, i1) > ten[0][1]){
  1053	          
  1054	          ten[0][1] = I3D(oz, n1, n2, i3, i2, i1);
  1055	          j1[0][1] = i1;
  1056	          j2[0][1] = i2;
  1057	          j3[0][1] = i3;
  1058	          bubble(ten, j1, j2, j3, mm, 1);
  1059	        }

thinking
**Detailing loop analysis and classification**

Completed a thorough classification of key loops in the multigrid code, assigning priorities and loop types per instructions with critical loops in main iteration, mg3P levels, psinv, resid, interp; important loops in rprj3, comm3, zero3; and secondary loops in norm2u3, zran3, setup, power. Planned a structured analysis.md with detailed sections including loop nesting, loop details, summary table, and data descriptions referencing mg.c lines and array usage. Next, I'll create the analysis.md file under data/src/mg-omp using apply_patch with this comprehensive content.
file update
A /root/codex_baseline/serial_omp_nas_workdir/data/src/mg-omp/analysis.md
- **main it loop** (mg.c:195) Type A — driver over `nit`, invokes `mg3P`/`resid` each iteration.
  - contains multigrid V-cycle stages in `mg3P` (mg.c:344, mg.c:355) Type C2
    - `rprj3` restriction loops (mg.c:546, mg.c:561) Type G
    - `zero3` clears (mg.c:352, mg.c:358; body at mg.c:1242) Type A
    - `psinv` smoothing loops (mg.c:389, mg.c:401) Type G
    - `interp` prolongation loops (mg.c:632, mg.c:647, mg.c:660, mg.c:672, mg.c:685 and fallback at mg.c:722+) Type G
    - `resid` residual loops (mg.c:459, mg.c:473; also top-level mg.c:369) Type G
    - `comm3` halo updates (mg.c:913, mg.c:921, mg.c:929) Type A
- Setup/aux loops (mg.c:294, mg.c:299, mg.c:305; mg.c:270 timing print; norm/zran/power/zero) Type A/F/G, run during initialization or diagnostics only.

## Loop Details

### Loop: main at mg.c:195
- **Iterations:** `nit` (class dependent; 4–50)
- **Type:** A — flat driver loop over iterations
- **Parent loop:** none
- **Contains:** calls `mg3P` (V-cycle) then `resid`
- **Dependencies:** none in loop body
- **Nested bounds:** constant
- **Private vars:** `it`
- **Arrays:** indirect through called kernels
- **Issues:** none
- **Priority:** CRITICAL (wraps all work each timestep)

### Loop: mg3P V-cycle down-sweep at mg.c:344
- **Iterations:** levels `lt`→`lb+1` (log2 of problem size; ~5–10)
- **Type:** C2 — multigrid stage invoking coarse-grid restriction
- **Parent loop:** main mg.c:195
- **Contains:** calls `rprj3` (stencil on coarse grids)
- **Dependencies:** stage ordering across levels
- **Nested bounds:** constant level count
- **Private vars:** `k`, `j`
- **Arrays:** `r` (RW) via offsets
- **Issues:** stage dependency; coarse-grid sizes shrink quickly
- **Priority:** CRITICAL (part of each V-cycle)

### Loop: mg3P V-cycle mid-levels at mg.c:355
- **Iterations:** levels `lb+1..lt-1`
- **Type:** C2 — multigrid stage (prolongate/smooth)
- **Parent loop:** main mg.c:195
- **Contains:** `zero3` (Type A), `interp` (Type G), `resid` (Type G), `psinv` (Type G)
- **Dependencies:** level ordering
- **Nested bounds:** constant level count
- **Private vars:** `k`, `j`
- **Arrays:** `u`, `r`
- **Issues:** stage dependency; multiple grid-sized kernels per level
- **Priority:** CRITICAL

### Loop: psinv precompute at mg.c:389
- **Iterations:** `(n3-2)*(n2-2)*n1` (interior planes)
- **Type:** G — 7-point-like stencil producing neighbor sums into `r1/r2`
- **Parent loop:** none (function scope; invoked from mg3P levels)
- **Contains:** inner loops over `i2`, `i1`
- **Dependencies:** none; uses temporaries to break recurrences
- **Nested bounds:** constant
- **Private vars:** `i3`, `i2`, `i1`
- **Arrays:** `orr(R)`, `r1(W)`, `r2(W)`
- **Issues:** scratch allocation each call; memory bandwidth bound
- **Priority:** CRITICAL

### Loop: psinv update at mg.c:401
- **Iterations:** `(n3-2)*(n2-2)*(n1-2)`
- **Type:** G — stencil smoothing writing `ou`
- **Parent loop:** none
- **Contains:** inner loops over `i2`, `i1`
- **Dependencies:** none; uses `r1/r2`
- **Nested bounds:** constant
- **Private vars:** `i3`, `i2`, `i1`
- **Arrays:** `ou(RW)`, `orr(R)`, `r1(R)`, `r2(R)`
- **Issues:** reuse of `ou` in-place; halo required via `comm3`
- **Priority:** CRITICAL

### Loop: resid neighbor sums at mg.c:459
- **Iterations:** `(n3-2)*(n2-2)*n1`
- **Type:** G — neighbor aggregation into temporaries
- **Parent loop:** none
- **Contains:** inner loops over `i2`, `i1`
- **Dependencies:** none
- **Nested bounds:** constant
- **Private vars:** `i3`, `i2`, `i1`
- **Arrays:** `ou(R)`, `u1(W)`, `u2(W)`
- **Issues:** scratch alloc each call
- **Priority:** CRITICAL

### Loop: resid compute at mg.c:473
- **Iterations:** `(n3-2)*(n2-2)*(n1-2)`
- **Type:** G — stencil residual write to `orr`
- **Parent loop:** none
- **Contains:** inner loops over `i2`, `i1`
- **Dependencies:** none
- **Nested bounds:** constant
- **Private vars:** `i3`, `i2`, `i1`
- **Arrays:** `orr(W)`, `ov(R)`, `ou(R)`, `u1(R)`, `u2(R)`
- **Issues:** halo update needed after (`comm3`)
- **Priority:** CRITICAL

### Loop: rprj3 neighbor prep at mg.c:546
- **Iterations:** `(m3j-2)*(m2j-2)*(m1j-1)` on coarse-grid faces
- **Type:** G — stencil averaging into `x1/y1`
- **Parent loop:** mg3P level loop mg.c:344
- **Contains:** inner loops over `j2`, `j1`
- **Dependencies:** none
- **Nested bounds:** constant
- **Private vars:** `j3`, `j2`, `j1`, `i3`, `i2`, `i1`
- **Arrays:** `orr(R)`, `x1(W)`, `y1(W)`
- **Issues:** scratch alloc; irregular offsets (`d1/d2/d3`)
- **Priority:** IMPORTANT

### Loop: rprj3 restrict at mg.c:561
- **Iterations:** `(m3j-2)*(m2j-2)*(m1j-2)`
- **Type:** G — stencil restriction writing coarse grid `os`
- **Parent loop:** mg3P level loop mg.c:344
- **Contains:** inner loops over `j2`, `j1`
- **Dependencies:** none
- **Nested bounds:** constant
- **Private vars:** `j3`, `j2`, `j1`, `i3`, `i2`, `i1`
- **Arrays:** `orr(R)`, `x1(R)`, `y1(R)`, `os(W)`
- **Issues:** fractional weights; needs halo after (`comm3`)
- **Priority:** IMPORTANT

### Loop: interp z-prep at mg.c:632
- **Iterations:** `(mm3-1)*(mm2-1)*mm1`
- **Type:** G — computes partial sums (`z1/z2/z3`) for prolongation
- **Parent loop:** mg3P level loop mg.c:355
- **Contains:** inner loops over `i2`, `i1`
- **Dependencies:** none
- **Nested bounds:** constant
- **Private vars:** `i3`, `i2`, `i1`
- **Arrays:** `oz(R)`, `z1/2/3(W)`
- **Issues:** scratch alloc; dominates memory traffic
- **Priority:** CRITICAL

### Loop: interp inject corners/edges/faces (mg.c:647, mg.c:660, mg.c:672, mg.c:685)
- **Iterations:** multiple `(mm3-1)*(mm2-1)*(mm1-1)` style loops
- **Type:** G — stencil-based prolongation writing `ou`
- **Parent loop:** mg3P level loop mg.c:355
- **Contains:** inner loops over `i2`, `i1`
- **Dependencies:** none
- **Nested bounds:** constant
- **Private vars:** `i3`, `i2`, `i1`
- **Arrays:** `ou(RW)`, `oz(R)`, `z1/2/3(R)`
- **Issues:** overlapping writes to `ou` across loops; order-dependent but no cross-iteration dependency
- **Priority:** CRITICAL

### Loop: interp small-grid fallback at mg.c:722–821
- **Iterations:** multiple `(mm3-?)*(mm2-?)*(mm1-?)` depending on `d1/d2/d3`
- **Type:** G — prolongation for 3-point edges
- **Parent loop:** mg3P level loop mg.c:355
- **Contains:** several triple loops
- **Dependencies:** none
- **Nested bounds:** constant
- **Private vars:** `i3`, `i2`, `i1`
- **Arrays:** `ou(RW)`, `oz(R)`
- **Issues:** branchy bounds for tiny grids
- **Priority:** IMPORTANT (smaller grids)

### Loop: comm3 halos at mg.c:913 / 921 / 929
- **Iterations:** surfaces: `(n3-2)*(n2-2)`, `(n3-2)*n1`, `n2*n1`
- **Type:** A — boundary copy/periodic wrap
- **Parent loop:** called after psinv/resid/rprj3
- **Contains:** 2D nested loops within each block
- **Dependencies:** halo must follow stencil updates
- **Nested bounds:** constant
- **Private vars:** `i3`, `i2`, `i1`
- **Arrays:** `ou(RW)`
- **Issues:** none; ensure ordering after stencil kernels
- **Priority:** IMPORTANT

### Loop: norm2u3 reduction at mg.c:881
- **Iterations:** `(n3-2)*(n2-2)*(n1-2)`
- **Type:** F — reduction on `s` (sum of squares) and `temp` (max)
- **Parent loop:** none (called pre/post benchmark)
- **Contains:** inner loops over `i2`, `i1`
- **Dependencies:** reduction on scalars
- **Nested bounds:** constant
- **Private vars:** `i3`, `i2`, `i1`, `s`, `a`, `temp`
- **Arrays:** `orr(R)`
- **Issues:** needs reduction/atomic if parallelized; not in main iteration body
- **Priority:** SECONDARY

### Loop: zero3 fill at mg.c:1242
- **Iterations:** `n3*n2*n1`
- **Type:** A — dense memset of 3D field
- **Parent loop:** used inside mg3P level loop mg.c:355 and setup
- **Contains:** inner loops over `i2`, `i1`
- **Dependencies:** none
- **Nested bounds:** constant
- **Private vars:** `i3`, `i2`, `i1`
- **Arrays:** `oz(W)`
- **Issues:** bandwidth bound
- **Priority:** IMPORTANT

### Loop: zran3 RNG fill at mg.c:1026
- **Iterations:** `(e3-1)*(e2-1)` outer with inner `vranlc(d1)` (d1 elements)
- **Type:** A — dense initialization with RNG; inner RNG loop is recurrence (Type E) inside `vranlc`
- **Parent loop:** initialization block (not timed iteration)
- **Contains:** call to `vranlc` (recurrence)
- **Dependencies:** RNG recurrence inside `vranlc`
- **Nested bounds:** constant
- **Private vars:** `i3`, `i2`
- **Arrays:** `oz(W)`
- **Issues:** RNG recurrence; setup only
- **Priority:** SECONDARY

### Loop: power exponentiation at mg.c:1173
- **Iterations:** while over bits of exponent `n` (log2(nx*ny*...))
- **Type:** E — loop-carried state via `randlc`
- **Parent loop:** none
- **Contains:** none
- **Dependencies:** RNG recurrence
- **Nested bounds:** variable
- **Private vars:** `nj`, `aj`
- **Arrays:** none
- **Issues:** sequential; setup-only
- **Priority:** SECONDARY

## Summary Table
| Function | Type | Priority | Parent | Iterations | Dependencies | Issues |
|----------|------|----------|--------|------------|--------------|--------|
| main (it loop) | A | CRITICAL | none | `nit` | none | driver only |
| mg3P level down (mg.c:344) | C2 | CRITICAL | main it | `lt-lb` | stage order | multigrid traversal |
| mg3P mid levels (mg.c:355) | C2 | CRITICAL | main it | `lt-lb-1` | stage order | multiple kernels/level |
| psinv stencil (mg.c:389/401) | G | CRITICAL | mg3P level | `(n3-2)*(n2-2)*n1` etc | none | halo after |
| resid stencil (mg.c:459/473) | G | CRITICAL | mg3P level & main resid | `(n3-2)*(n2-2)*n1` etc | none | halo after |
| rprj3 stencil (mg.c:546/561) | G | IMPORTANT | mg3P down | coarse-grid volume | none | scratch alloc |
| interp stencil (mg.c:632–821) | G | CRITICAL/IMPORTANT (fallback) | mg3P up | fine-grid volume | none | overlapping writes |
| comm3 halos (mg.c:913/921/929) | A | IMPORTANT | stencil kernels | surface sizes | order after compute | boundary copy |
| norm2u3 reduction (mg.c:881) | F | SECONDARY | none | interior volume | reduction on `s/temp` | not per iter |
| zero3 fill (mg.c:1242) | A | IMPORTANT | mg3P/setup | full grid | none | bandwidth bound |
| zran3 RNG (mg.c:1026) | A/E | SECONDARY | init | `(e3-1)*(e2-1)*d1` | RNG recurrence | setup only |
| power (mg.c:1173) | E | SECONDARY | init | O(log n) | RNG recurrence | sequential |

## Data Details
- **Dominant compute loop:** `for (it=1; it<=nit; ++it)` in `main`, executing `mg3P` V-cycle (restriction → smoothing → prolongation) plus `resid` per timestep.
- **Arrays swapped between functions?:** NO; `u`, `v`, `r` are static 1D grids indexed via `I3D`; temporaries (`r1/r2`, `u1/u2`, `x1/y1`, `z1/z2/z3`) are allocated per kernel call, not swapped.
- **Scratch arrays?:** YES; each stencil kernel allocates local work arrays (`r1/r2`, `u1/u2`, `x1/y1`, `z1/z2/z3`) sized to the active grid.
- **Mid-computation sync?:** NO explicit barriers; `comm3` performs halo copies after stencil updates to refresh ghost cells.
- **RNG in timed loop?:** NO; RNG (`zran3`, `power`, `randlc/vranlc`) occurs during setup (T_init) only.
apply_patch(auto_approved=true) exited 0 in 5ms:
Success. Updated the following files:
A data/src/mg-omp/analysis.md
file update:
diff --git a/serial_omp_nas_workdir/data/src/mg-omp/analysis.md b/serial_omp_nas_workdir/data/src/mg-omp/analysis.md
new file mode 100644
index 0000000000000000000000000000000000000000..b194d0487bb170d72fba2d4b296e95868aa4a460
--- /dev/null
+++ b/serial_omp_nas_workdir/data/src/mg-omp/analysis.md
@@ -0,0 +1,238 @@
+- **main it loop** (mg.c:195) Type A — driver over `nit`, invokes `mg3P`/`resid` each iteration.
+  - contains multigrid V-cycle stages in `mg3P` (mg.c:344, mg.c:355) Type C2
+    - `rprj3` restriction loops (mg.c:546, mg.c:561) Type G
+    - `zero3` clears (mg.c:352, mg.c:358; body at mg.c:1242) Type A
+    - `psinv` smoothing loops (mg.c:389, mg.c:401) Type G
+    - `interp` prolongation loops (mg.c:632, mg.c:647, mg.c:660, mg.c:672, mg.c:685 and fallback at mg.c:722+) Type G
+    - `resid` residual loops (mg.c:459, mg.c:473; also top-level mg.c:369) Type G
+    - `comm3` halo updates (mg.c:913, mg.c:921, mg.c:929) Type A
+- Setup/aux loops (mg.c:294, mg.c:299, mg.c:305; mg.c:270 timing print; norm/zran/power/zero) Type A/F/G, run during initialization or diagnostics only.
+
+## Loop Details
+
+### Loop: main at mg.c:195
+- **Iterations:** `nit` (class dependent; 4–50)
+- **Type:** A — flat driver loop over iterations
+- **Parent loop:** none
+- **Contains:** calls `mg3P` (V-cycle) then `resid`
+- **Dependencies:** none in loop body
+- **Nested bounds:** constant
+- **Private vars:** `it`
+- **Arrays:** indirect through called kernels
+- **Issues:** none
+- **Priority:** CRITICAL (wraps all work each timestep)
+
+### Loop: mg3P V-cycle down-sweep at mg.c:344
+- **Iterations:** levels `lt`→`lb+1` (log2 of problem size; ~5–10)
+- **Type:** C2 — multigrid stage invoking coarse-grid restriction
+- **Parent loop:** main mg.c:195
+- **Contains:** calls `rprj3` (stencil on coarse grids)
+- **Dependencies:** stage ordering across levels
+- **Nested bounds:** constant level count
+- **Private vars:** `k`, `j`
+- **Arrays:** `r` (RW) via offsets
+- **Issues:** stage dependency; coarse-grid sizes shrink quickly
+- **Priority:** CRITICAL (part of each V-cycle)
+
+### Loop: mg3P V-cycle mid-levels at mg.c:355
+- **Iterations:** levels `lb+1..lt-1`
+- **Type:** C2 — multigrid stage (prolongate/smooth)
+- **Parent loop:** main mg.c:195
+- **Contains:** `zero3` (Type A), `interp` (Type G), `resid` (Type G), `psinv` (Type G)
+- **Dependencies:** level ordering
+- **Nested bounds:** constant level count
+- **Private vars:** `k`, `j`
+- **Arrays:** `u`, `r`
+- **Issues:** stage dependency; multiple grid-sized kernels per level
+- **Priority:** CRITICAL
+
+### Loop: psinv precompute at mg.c:389
+- **Iterations:** `(n3-2)*(n2-2)*n1` (interior planes)
+- **Type:** G — 7-point-like stencil producing neighbor sums into `r1/r2`
+- **Parent loop:** none (function scope; invoked from mg3P levels)
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none; uses temporaries to break recurrences
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `orr(R)`, `r1(W)`, `r2(W)`
+- **Issues:** scratch allocation each call; memory bandwidth bound
+- **Priority:** CRITICAL
+
+### Loop: psinv update at mg.c:401
+- **Iterations:** `(n3-2)*(n2-2)*(n1-2)`
+- **Type:** G — stencil smoothing writing `ou`
+- **Parent loop:** none
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none; uses `r1/r2`
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `ou(RW)`, `orr(R)`, `r1(R)`, `r2(R)`
+- **Issues:** reuse of `ou` in-place; halo required via `comm3`
+- **Priority:** CRITICAL
+
+### Loop: resid neighbor sums at mg.c:459
+- **Iterations:** `(n3-2)*(n2-2)*n1`
+- **Type:** G — neighbor aggregation into temporaries
+- **Parent loop:** none
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `ou(R)`, `u1(W)`, `u2(W)`
+- **Issues:** scratch alloc each call
+- **Priority:** CRITICAL
+
+### Loop: resid compute at mg.c:473
+- **Iterations:** `(n3-2)*(n2-2)*(n1-2)`
+- **Type:** G — stencil residual write to `orr`
+- **Parent loop:** none
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `orr(W)`, `ov(R)`, `ou(R)`, `u1(R)`, `u2(R)`
+- **Issues:** halo update needed after (`comm3`)
+- **Priority:** CRITICAL
+
+### Loop: rprj3 neighbor prep at mg.c:546
+- **Iterations:** `(m3j-2)*(m2j-2)*(m1j-1)` on coarse-grid faces
+- **Type:** G — stencil averaging into `x1/y1`
+- **Parent loop:** mg3P level loop mg.c:344
+- **Contains:** inner loops over `j2`, `j1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `j3`, `j2`, `j1`, `i3`, `i2`, `i1`
+- **Arrays:** `orr(R)`, `x1(W)`, `y1(W)`
+- **Issues:** scratch alloc; irregular offsets (`d1/d2/d3`)
+- **Priority:** IMPORTANT
+
+### Loop: rprj3 restrict at mg.c:561
+- **Iterations:** `(m3j-2)*(m2j-2)*(m1j-2)`
+- **Type:** G — stencil restriction writing coarse grid `os`
+- **Parent loop:** mg3P level loop mg.c:344
+- **Contains:** inner loops over `j2`, `j1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `j3`, `j2`, `j1`, `i3`, `i2`, `i1`
+- **Arrays:** `orr(R)`, `x1(R)`, `y1(R)`, `os(W)`
+- **Issues:** fractional weights; needs halo after (`comm3`)
+- **Priority:** IMPORTANT
+
+### Loop: interp z-prep at mg.c:632
+- **Iterations:** `(mm3-1)*(mm2-1)*mm1`
+- **Type:** G — computes partial sums (`z1/z2/z3`) for prolongation
+- **Parent loop:** mg3P level loop mg.c:355
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `oz(R)`, `z1/2/3(W)`
+- **Issues:** scratch alloc; dominates memory traffic
+- **Priority:** CRITICAL
+
+### Loop: interp inject corners/edges/faces (mg.c:647, mg.c:660, mg.c:672, mg.c:685)
+- **Iterations:** multiple `(mm3-1)*(mm2-1)*(mm1-1)` style loops
+- **Type:** G — stencil-based prolongation writing `ou`
+- **Parent loop:** mg3P level loop mg.c:355
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `ou(RW)`, `oz(R)`, `z1/2/3(R)`
+- **Issues:** overlapping writes to `ou` across loops; order-dependent but no cross-iteration dependency
+- **Priority:** CRITICAL
+
+### Loop: interp small-grid fallback at mg.c:722–821
+- **Iterations:** multiple `(mm3-?)*(mm2-?)*(mm1-?)` depending on `d1/d2/d3`
+- **Type:** G — prolongation for 3-point edges
+- **Parent loop:** mg3P level loop mg.c:355
+- **Contains:** several triple loops
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `ou(RW)`, `oz(R)`
+- **Issues:** branchy bounds for tiny grids
+- **Priority:** IMPORTANT (smaller grids)
+
+### Loop: comm3 halos at mg.c:913 / 921 / 929
+- **Iterations:** surfaces: `(n3-2)*(n2-2)`, `(n3-2)*n1`, `n2*n1`
+- **Type:** A — boundary copy/periodic wrap
+- **Parent loop:** called after psinv/resid/rprj3
+- **Contains:** 2D nested loops within each block
+- **Dependencies:** halo must follow stencil updates
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `ou(RW)`
+- **Issues:** none; ensure ordering after stencil kernels
+- **Priority:** IMPORTANT
+
+### Loop: norm2u3 reduction at mg.c:881
+- **Iterations:** `(n3-2)*(n2-2)*(n1-2)`
+- **Type:** F — reduction on `s` (sum of squares) and `temp` (max)
+- **Parent loop:** none (called pre/post benchmark)
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** reduction on scalars
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`, `s`, `a`, `temp`
+- **Arrays:** `orr(R)`
+- **Issues:** needs reduction/atomic if parallelized; not in main iteration body
+- **Priority:** SECONDARY
+
+### Loop: zero3 fill at mg.c:1242
+- **Iterations:** `n3*n2*n1`
+- **Type:** A — dense memset of 3D field
+- **Parent loop:** used inside mg3P level loop mg.c:355 and setup
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `oz(W)`
+- **Issues:** bandwidth bound
+- **Priority:** IMPORTANT
+
+### Loop: zran3 RNG fill at mg.c:1026
+- **Iterations:** `(e3-1)*(e2-1)` outer with inner `vranlc(d1)` (d1 elements)
+- **Type:** A — dense initialization with RNG; inner RNG loop is recurrence (Type E) inside `vranlc`
+- **Parent loop:** initialization block (not timed iteration)
+- **Contains:** call to `vranlc` (recurrence)
+- **Dependencies:** RNG recurrence inside `vranlc`
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`
+- **Arrays:** `oz(W)`
+- **Issues:** RNG recurrence; setup only
+- **Priority:** SECONDARY
+
+### Loop: power exponentiation at mg.c:1173
+- **Iterations:** while over bits of exponent `n` (log2(nx*ny*...))
+- **Type:** E — loop-carried state via `randlc`
+- **Parent loop:** none
+- **Contains:** none
+- **Dependencies:** RNG recurrence
+- **Nested bounds:** variable
+- **Private vars:** `nj`, `aj`
+- **Arrays:** none
+- **Issues:** sequential; setup-only
+- **Priority:** SECONDARY
+
+## Summary Table
+| Function | Type | Priority | Parent | Iterations | Dependencies | Issues |
+|----------|------|----------|--------|------------|--------------|--------|
+| main (it loop) | A | CRITICAL | none | `nit` | none | driver only |
+| mg3P level down (mg.c:344) | C2 | CRITICAL | main it | `lt-lb` | stage order | multigrid traversal |
+| mg3P mid levels (mg.c:355) | C2 | CRITICAL | main it | `lt-lb-1` | stage order | multiple kernels/level |
+| psinv stencil (mg.c:389/401) | G | CRITICAL | mg3P level | `(n3-2)*(n2-2)*n1` etc | none | halo after |
+| resid stencil (mg.c:459/473) | G | CRITICAL | mg3P level & main resid | `(n3-2)*(n2-2)*n1` etc | none | halo after |
+| rprj3 stencil (mg.c:546/561) | G | IMPORTANT | mg3P down | coarse-grid volume | none | scratch alloc |
+| interp stencil (mg.c:632–821) | G | CRITICAL/IMPORTANT (fallback) | mg3P up | fine-grid volume | none | overlapping writes |
+| comm3 halos (mg.c:913/921/929) | A | IMPORTANT | stencil kernels | surface sizes | order after compute | boundary copy |
+| norm2u3 reduction (mg.c:881) | F | SECONDARY | none | interior volume | reduction on `s/temp` | not per iter |
+| zero3 fill (mg.c:1242) | A | IMPORTANT | mg3P/setup | full grid | none | bandwidth bound |
+| zran3 RNG (mg.c:1026) | A/E | SECONDARY | init | `(e3-1)*(e2-1)*d1` | RNG recurrence | setup only |
+| power (mg.c:1173) | E | SECONDARY | init | O(log n) | RNG recurrence | sequential |
+
+## Data Details
+- **Dominant compute loop:** `for (it=1; it<=nit; ++it)` in `main`, executing `mg3P` V-cycle (restriction → smoothing → prolongation) plus `resid` per timestep.
+- **Arrays swapped between functions?:** NO; `u`, `v`, `r` are static 1D grids indexed via `I3D`; temporaries (`r1/r2`, `u1/u2`, `x1/y1`, `z1/z2/z3`) are allocated per kernel call, not swapped.
+- **Scratch arrays?:** YES; each stencil kernel allocates local work arrays (`r1/r2`, `u1/u2`, `x1/y1`, `z1/z2/z3`) sized to the active grid.
+- **Mid-computation sync?:** NO explicit barriers; `comm3` performs halo copies after stencil updates to refresh ghost cells.
+- **RNG in timed loop?:** NO; RNG (`zran3`, `power`, `randlc/vranlc`) occurs during setup (T_init) only.

file update:
diff --git a/serial_omp_nas_workdir/data/src/mg-omp/analysis.md b/serial_omp_nas_workdir/data/src/mg-omp/analysis.md
new file mode 100644
index 0000000000000000000000000000000000000000..b194d0487bb170d72fba2d4b296e95868aa4a460
--- /dev/null
+++ b/serial_omp_nas_workdir/data/src/mg-omp/analysis.md
@@ -0,0 +1,238 @@
+- **main it loop** (mg.c:195) Type A — driver over `nit`, invokes `mg3P`/`resid` each iteration.
+  - contains multigrid V-cycle stages in `mg3P` (mg.c:344, mg.c:355) Type C2
+    - `rprj3` restriction loops (mg.c:546, mg.c:561) Type G
+    - `zero3` clears (mg.c:352, mg.c:358; body at mg.c:1242) Type A
+    - `psinv` smoothing loops (mg.c:389, mg.c:401) Type G
+    - `interp` prolongation loops (mg.c:632, mg.c:647, mg.c:660, mg.c:672, mg.c:685 and fallback at mg.c:722+) Type G
+    - `resid` residual loops (mg.c:459, mg.c:473; also top-level mg.c:369) Type G
+    - `comm3` halo updates (mg.c:913, mg.c:921, mg.c:929) Type A
+- Setup/aux loops (mg.c:294, mg.c:299, mg.c:305; mg.c:270 timing print; norm/zran/power/zero) Type A/F/G, run during initialization or diagnostics only.
+
+## Loop Details
+
+### Loop: main at mg.c:195
+- **Iterations:** `nit` (class dependent; 4–50)
+- **Type:** A — flat driver loop over iterations
+- **Parent loop:** none
+- **Contains:** calls `mg3P` (V-cycle) then `resid`
+- **Dependencies:** none in loop body
+- **Nested bounds:** constant
+- **Private vars:** `it`
+- **Arrays:** indirect through called kernels
+- **Issues:** none
+- **Priority:** CRITICAL (wraps all work each timestep)
+
+### Loop: mg3P V-cycle down-sweep at mg.c:344
+- **Iterations:** levels `lt`→`lb+1` (log2 of problem size; ~5–10)
+- **Type:** C2 — multigrid stage invoking coarse-grid restriction
+- **Parent loop:** main mg.c:195
+- **Contains:** calls `rprj3` (stencil on coarse grids)
+- **Dependencies:** stage ordering across levels
+- **Nested bounds:** constant level count
+- **Private vars:** `k`, `j`
+- **Arrays:** `r` (RW) via offsets
+- **Issues:** stage dependency; coarse-grid sizes shrink quickly
+- **Priority:** CRITICAL (part of each V-cycle)
+
+### Loop: mg3P V-cycle mid-levels at mg.c:355
+- **Iterations:** levels `lb+1..lt-1`
+- **Type:** C2 — multigrid stage (prolongate/smooth)
+- **Parent loop:** main mg.c:195
+- **Contains:** `zero3` (Type A), `interp` (Type G), `resid` (Type G), `psinv` (Type G)
+- **Dependencies:** level ordering
+- **Nested bounds:** constant level count
+- **Private vars:** `k`, `j`
+- **Arrays:** `u`, `r`
+- **Issues:** stage dependency; multiple grid-sized kernels per level
+- **Priority:** CRITICAL
+
+### Loop: psinv precompute at mg.c:389
+- **Iterations:** `(n3-2)*(n2-2)*n1` (interior planes)
+- **Type:** G — 7-point-like stencil producing neighbor sums into `r1/r2`
+- **Parent loop:** none (function scope; invoked from mg3P levels)
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none; uses temporaries to break recurrences
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `orr(R)`, `r1(W)`, `r2(W)`
+- **Issues:** scratch allocation each call; memory bandwidth bound
+- **Priority:** CRITICAL
+
+### Loop: psinv update at mg.c:401
+- **Iterations:** `(n3-2)*(n2-2)*(n1-2)`
+- **Type:** G — stencil smoothing writing `ou`
+- **Parent loop:** none
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none; uses `r1/r2`
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `ou(RW)`, `orr(R)`, `r1(R)`, `r2(R)`
+- **Issues:** reuse of `ou` in-place; halo required via `comm3`
+- **Priority:** CRITICAL
+
+### Loop: resid neighbor sums at mg.c:459
+- **Iterations:** `(n3-2)*(n2-2)*n1`
+- **Type:** G — neighbor aggregation into temporaries
+- **Parent loop:** none
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `ou(R)`, `u1(W)`, `u2(W)`
+- **Issues:** scratch alloc each call
+- **Priority:** CRITICAL
+
+### Loop: resid compute at mg.c:473
+- **Iterations:** `(n3-2)*(n2-2)*(n1-2)`
+- **Type:** G — stencil residual write to `orr`
+- **Parent loop:** none
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `orr(W)`, `ov(R)`, `ou(R)`, `u1(R)`, `u2(R)`
+- **Issues:** halo update needed after (`comm3`)
+- **Priority:** CRITICAL
+
+### Loop: rprj3 neighbor prep at mg.c:546
+- **Iterations:** `(m3j-2)*(m2j-2)*(m1j-1)` on coarse-grid faces
+- **Type:** G — stencil averaging into `x1/y1`
+- **Parent loop:** mg3P level loop mg.c:344
+- **Contains:** inner loops over `j2`, `j1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `j3`, `j2`, `j1`, `i3`, `i2`, `i1`
+- **Arrays:** `orr(R)`, `x1(W)`, `y1(W)`
+- **Issues:** scratch alloc; irregular offsets (`d1/d2/d3`)
+- **Priority:** IMPORTANT
+
+### Loop: rprj3 restrict at mg.c:561
+- **Iterations:** `(m3j-2)*(m2j-2)*(m1j-2)`
+- **Type:** G — stencil restriction writing coarse grid `os`
+- **Parent loop:** mg3P level loop mg.c:344
+- **Contains:** inner loops over `j2`, `j1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `j3`, `j2`, `j1`, `i3`, `i2`, `i1`
+- **Arrays:** `orr(R)`, `x1(R)`, `y1(R)`, `os(W)`
+- **Issues:** fractional weights; needs halo after (`comm3`)
+- **Priority:** IMPORTANT
+
+### Loop: interp z-prep at mg.c:632
+- **Iterations:** `(mm3-1)*(mm2-1)*mm1`
+- **Type:** G — computes partial sums (`z1/z2/z3`) for prolongation
+- **Parent loop:** mg3P level loop mg.c:355
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `oz(R)`, `z1/2/3(W)`
+- **Issues:** scratch alloc; dominates memory traffic
+- **Priority:** CRITICAL
+
+### Loop: interp inject corners/edges/faces (mg.c:647, mg.c:660, mg.c:672, mg.c:685)
+- **Iterations:** multiple `(mm3-1)*(mm2-1)*(mm1-1)` style loops
+- **Type:** G — stencil-based prolongation writing `ou`
+- **Parent loop:** mg3P level loop mg.c:355
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `ou(RW)`, `oz(R)`, `z1/2/3(R)`
+- **Issues:** overlapping writes to `ou` across loops; order-dependent but no cross-iteration dependency
+- **Priority:** CRITICAL
+
+### Loop: interp small-grid fallback at mg.c:722–821
+- **Iterations:** multiple `(mm3-?)*(mm2-?)*(mm1-?)` depending on `d1/d2/d3`
+- **Type:** G — prolongation for 3-point edges
+- **Parent loop:** mg3P level loop mg.c:355
+- **Contains:** several triple loops
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `ou(RW)`, `oz(R)`
+- **Issues:** branchy bounds for tiny grids
+- **Priority:** IMPORTANT (smaller grids)
+
+### Loop: comm3 halos at mg.c:913 / 921 / 929
+- **Iterations:** surfaces: `(n3-2)*(n2-2)`, `(n3-2)*n1`, `n2*n1`
+- **Type:** A — boundary copy/periodic wrap
+- **Parent loop:** called after psinv/resid/rprj3
+- **Contains:** 2D nested loops within each block
+- **Dependencies:** halo must follow stencil updates
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `ou(RW)`
+- **Issues:** none; ensure ordering after stencil kernels
+- **Priority:** IMPORTANT
+
+### Loop: norm2u3 reduction at mg.c:881
+- **Iterations:** `(n3-2)*(n2-2)*(n1-2)`
+- **Type:** F — reduction on `s` (sum of squares) and `temp` (max)
+- **Parent loop:** none (called pre/post benchmark)
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** reduction on scalars
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`, `s`, `a`, `temp`
+- **Arrays:** `orr(R)`
+- **Issues:** needs reduction/atomic if parallelized; not in main iteration body
+- **Priority:** SECONDARY
+
+### Loop: zero3 fill at mg.c:1242
+- **Iterations:** `n3*n2*n1`
+- **Type:** A — dense memset of 3D field
+- **Parent loop:** used inside mg3P level loop mg.c:355 and setup
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `oz(W)`
+- **Issues:** bandwidth bound
+- **Priority:** IMPORTANT
+
+### Loop: zran3 RNG fill at mg.c:1026
+- **Iterations:** `(e3-1)*(e2-1)` outer with inner `vranlc(d1)` (d1 elements)
+- **Type:** A — dense initialization with RNG; inner RNG loop is recurrence (Type E) inside `vranlc`
+- **Parent loop:** initialization block (not timed iteration)
+- **Contains:** call to `vranlc` (recurrence)
+- **Dependencies:** RNG recurrence inside `vranlc`
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`
+- **Arrays:** `oz(W)`
+- **Issues:** RNG recurrence; setup only
+- **Priority:** SECONDARY
+
+### Loop: power exponentiation at mg.c:1173
+- **Iterations:** while over bits of exponent `n` (log2(nx*ny*...))
+- **Type:** E — loop-carried state via `randlc`
+- **Parent loop:** none
+- **Contains:** none
+- **Dependencies:** RNG recurrence
+- **Nested bounds:** variable
+- **Private vars:** `nj`, `aj`
+- **Arrays:** none
+- **Issues:** sequential; setup-only
+- **Priority:** SECONDARY
+
+## Summary Table
+| Function | Type | Priority | Parent | Iterations | Dependencies | Issues |
+|----------|------|----------|--------|------------|--------------|--------|
+| main (it loop) | A | CRITICAL | none | `nit` | none | driver only |
+| mg3P level down (mg.c:344) | C2 | CRITICAL | main it | `lt-lb` | stage order | multigrid traversal |
+| mg3P mid levels (mg.c:355) | C2 | CRITICAL | main it | `lt-lb-1` | stage order | multiple kernels/level |
+| psinv stencil (mg.c:389/401) | G | CRITICAL | mg3P level | `(n3-2)*(n2-2)*n1` etc | none | halo after |
+| resid stencil (mg.c:459/473) | G | CRITICAL | mg3P level & main resid | `(n3-2)*(n2-2)*n1` etc | none | halo after |
+| rprj3 stencil (mg.c:546/561) | G | IMPORTANT | mg3P down | coarse-grid volume | none | scratch alloc |
+| interp stencil (mg.c:632–821) | G | CRITICAL/IMPORTANT (fallback) | mg3P up | fine-grid volume | none | overlapping writes |
+| comm3 halos (mg.c:913/921/929) | A | IMPORTANT | stencil kernels | surface sizes | order after compute | boundary copy |
+| norm2u3 reduction (mg.c:881) | F | SECONDARY | none | interior volume | reduction on `s/temp` | not per iter |
+| zero3 fill (mg.c:1242) | A | IMPORTANT | mg3P/setup | full grid | none | bandwidth bound |
+| zran3 RNG (mg.c:1026) | A/E | SECONDARY | init | `(e3-1)*(e2-1)*d1` | RNG recurrence | setup only |
+| power (mg.c:1173) | E | SECONDARY | init | O(log n) | RNG recurrence | sequential |
+
+## Data Details
+- **Dominant compute loop:** `for (it=1; it<=nit; ++it)` in `main`, executing `mg3P` V-cycle (restriction → smoothing → prolongation) plus `resid` per timestep.
+- **Arrays swapped between functions?:** NO; `u`, `v`, `r` are static 1D grids indexed via `I3D`; temporaries (`r1/r2`, `u1/u2`, `x1/y1`, `z1/z2/z3`) are allocated per kernel call, not swapped.
+- **Scratch arrays?:** YES; each stencil kernel allocates local work arrays (`r1/r2`, `u1/u2`, `x1/y1`, `z1/z2/z3`) sized to the active grid.
+- **Mid-computation sync?:** NO explicit barriers; `comm3` performs halo copies after stencil updates to refresh ghost cells.
+- **RNG in timed loop?:** NO; RNG (`zran3`, `power`, `randlc/vranlc`) occurs during setup (T_init) only.


thinking
**Summarizing final changes and next steps**

Copied `mg.c` to the specified data path and created an analysis file classifying loops and summarizing control flow. No tests were run and the Makefile remains unchanged. Next steps include verifying the copied file and running benchmarks to confirm no build issues.
codex
Copied the original `mg.c` into `data/src/mg-omp/` and wrote the requested loop classification/analysis to `data/src/mg-omp/analysis.md`, covering the main iteration driver, multigrid stage loops, stencil kernels, reductions, halos, RNG/setup paths, and data/array characteristics.

No tests run.
file update:
diff --git a/serial_omp_nas_workdir/data/src/mg-omp/analysis.md b/serial_omp_nas_workdir/data/src/mg-omp/analysis.md
new file mode 100644
index 0000000000000000000000000000000000000000..b194d0487bb170d72fba2d4b296e95868aa4a460
--- /dev/null
+++ b/serial_omp_nas_workdir/data/src/mg-omp/analysis.md
@@ -0,0 +1,238 @@
+- **main it loop** (mg.c:195) Type A — driver over `nit`, invokes `mg3P`/`resid` each iteration.
+  - contains multigrid V-cycle stages in `mg3P` (mg.c:344, mg.c:355) Type C2
+    - `rprj3` restriction loops (mg.c:546, mg.c:561) Type G
+    - `zero3` clears (mg.c:352, mg.c:358; body at mg.c:1242) Type A
+    - `psinv` smoothing loops (mg.c:389, mg.c:401) Type G
+    - `interp` prolongation loops (mg.c:632, mg.c:647, mg.c:660, mg.c:672, mg.c:685 and fallback at mg.c:722+) Type G
+    - `resid` residual loops (mg.c:459, mg.c:473; also top-level mg.c:369) Type G
+    - `comm3` halo updates (mg.c:913, mg.c:921, mg.c:929) Type A
+- Setup/aux loops (mg.c:294, mg.c:299, mg.c:305; mg.c:270 timing print; norm/zran/power/zero) Type A/F/G, run during initialization or diagnostics only.
+
+## Loop Details
+
+### Loop: main at mg.c:195
+- **Iterations:** `nit` (class dependent; 4–50)
+- **Type:** A — flat driver loop over iterations
+- **Parent loop:** none
+- **Contains:** calls `mg3P` (V-cycle) then `resid`
+- **Dependencies:** none in loop body
+- **Nested bounds:** constant
+- **Private vars:** `it`
+- **Arrays:** indirect through called kernels
+- **Issues:** none
+- **Priority:** CRITICAL (wraps all work each timestep)
+
+### Loop: mg3P V-cycle down-sweep at mg.c:344
+- **Iterations:** levels `lt`→`lb+1` (log2 of problem size; ~5–10)
+- **Type:** C2 — multigrid stage invoking coarse-grid restriction
+- **Parent loop:** main mg.c:195
+- **Contains:** calls `rprj3` (stencil on coarse grids)
+- **Dependencies:** stage ordering across levels
+- **Nested bounds:** constant level count
+- **Private vars:** `k`, `j`
+- **Arrays:** `r` (RW) via offsets
+- **Issues:** stage dependency; coarse-grid sizes shrink quickly
+- **Priority:** CRITICAL (part of each V-cycle)
+
+### Loop: mg3P V-cycle mid-levels at mg.c:355
+- **Iterations:** levels `lb+1..lt-1`
+- **Type:** C2 — multigrid stage (prolongate/smooth)
+- **Parent loop:** main mg.c:195
+- **Contains:** `zero3` (Type A), `interp` (Type G), `resid` (Type G), `psinv` (Type G)
+- **Dependencies:** level ordering
+- **Nested bounds:** constant level count
+- **Private vars:** `k`, `j`
+- **Arrays:** `u`, `r`
+- **Issues:** stage dependency; multiple grid-sized kernels per level
+- **Priority:** CRITICAL
+
+### Loop: psinv precompute at mg.c:389
+- **Iterations:** `(n3-2)*(n2-2)*n1` (interior planes)
+- **Type:** G — 7-point-like stencil producing neighbor sums into `r1/r2`
+- **Parent loop:** none (function scope; invoked from mg3P levels)
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none; uses temporaries to break recurrences
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `orr(R)`, `r1(W)`, `r2(W)`
+- **Issues:** scratch allocation each call; memory bandwidth bound
+- **Priority:** CRITICAL
+
+### Loop: psinv update at mg.c:401
+- **Iterations:** `(n3-2)*(n2-2)*(n1-2)`
+- **Type:** G — stencil smoothing writing `ou`
+- **Parent loop:** none
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none; uses `r1/r2`
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `ou(RW)`, `orr(R)`, `r1(R)`, `r2(R)`
+- **Issues:** reuse of `ou` in-place; halo required via `comm3`
+- **Priority:** CRITICAL
+
+### Loop: resid neighbor sums at mg.c:459
+- **Iterations:** `(n3-2)*(n2-2)*n1`
+- **Type:** G — neighbor aggregation into temporaries
+- **Parent loop:** none
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `ou(R)`, `u1(W)`, `u2(W)`
+- **Issues:** scratch alloc each call
+- **Priority:** CRITICAL
+
+### Loop: resid compute at mg.c:473
+- **Iterations:** `(n3-2)*(n2-2)*(n1-2)`
+- **Type:** G — stencil residual write to `orr`
+- **Parent loop:** none
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `orr(W)`, `ov(R)`, `ou(R)`, `u1(R)`, `u2(R)`
+- **Issues:** halo update needed after (`comm3`)
+- **Priority:** CRITICAL
+
+### Loop: rprj3 neighbor prep at mg.c:546
+- **Iterations:** `(m3j-2)*(m2j-2)*(m1j-1)` on coarse-grid faces
+- **Type:** G — stencil averaging into `x1/y1`
+- **Parent loop:** mg3P level loop mg.c:344
+- **Contains:** inner loops over `j2`, `j1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `j3`, `j2`, `j1`, `i3`, `i2`, `i1`
+- **Arrays:** `orr(R)`, `x1(W)`, `y1(W)`
+- **Issues:** scratch alloc; irregular offsets (`d1/d2/d3`)
+- **Priority:** IMPORTANT
+
+### Loop: rprj3 restrict at mg.c:561
+- **Iterations:** `(m3j-2)*(m2j-2)*(m1j-2)`
+- **Type:** G — stencil restriction writing coarse grid `os`
+- **Parent loop:** mg3P level loop mg.c:344
+- **Contains:** inner loops over `j2`, `j1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `j3`, `j2`, `j1`, `i3`, `i2`, `i1`
+- **Arrays:** `orr(R)`, `x1(R)`, `y1(R)`, `os(W)`
+- **Issues:** fractional weights; needs halo after (`comm3`)
+- **Priority:** IMPORTANT
+
+### Loop: interp z-prep at mg.c:632
+- **Iterations:** `(mm3-1)*(mm2-1)*mm1`
+- **Type:** G — computes partial sums (`z1/z2/z3`) for prolongation
+- **Parent loop:** mg3P level loop mg.c:355
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `oz(R)`, `z1/2/3(W)`
+- **Issues:** scratch alloc; dominates memory traffic
+- **Priority:** CRITICAL
+
+### Loop: interp inject corners/edges/faces (mg.c:647, mg.c:660, mg.c:672, mg.c:685)
+- **Iterations:** multiple `(mm3-1)*(mm2-1)*(mm1-1)` style loops
+- **Type:** G — stencil-based prolongation writing `ou`
+- **Parent loop:** mg3P level loop mg.c:355
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `ou(RW)`, `oz(R)`, `z1/2/3(R)`
+- **Issues:** overlapping writes to `ou` across loops; order-dependent but no cross-iteration dependency
+- **Priority:** CRITICAL
+
+### Loop: interp small-grid fallback at mg.c:722–821
+- **Iterations:** multiple `(mm3-?)*(mm2-?)*(mm1-?)` depending on `d1/d2/d3`
+- **Type:** G — prolongation for 3-point edges
+- **Parent loop:** mg3P level loop mg.c:355
+- **Contains:** several triple loops
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `ou(RW)`, `oz(R)`
+- **Issues:** branchy bounds for tiny grids
+- **Priority:** IMPORTANT (smaller grids)
+
+### Loop: comm3 halos at mg.c:913 / 921 / 929
+- **Iterations:** surfaces: `(n3-2)*(n2-2)`, `(n3-2)*n1`, `n2*n1`
+- **Type:** A — boundary copy/periodic wrap
+- **Parent loop:** called after psinv/resid/rprj3
+- **Contains:** 2D nested loops within each block
+- **Dependencies:** halo must follow stencil updates
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `ou(RW)`
+- **Issues:** none; ensure ordering after stencil kernels
+- **Priority:** IMPORTANT
+
+### Loop: norm2u3 reduction at mg.c:881
+- **Iterations:** `(n3-2)*(n2-2)*(n1-2)`
+- **Type:** F — reduction on `s` (sum of squares) and `temp` (max)
+- **Parent loop:** none (called pre/post benchmark)
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** reduction on scalars
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`, `s`, `a`, `temp`
+- **Arrays:** `orr(R)`
+- **Issues:** needs reduction/atomic if parallelized; not in main iteration body
+- **Priority:** SECONDARY
+
+### Loop: zero3 fill at mg.c:1242
+- **Iterations:** `n3*n2*n1`
+- **Type:** A — dense memset of 3D field
+- **Parent loop:** used inside mg3P level loop mg.c:355 and setup
+- **Contains:** inner loops over `i2`, `i1`
+- **Dependencies:** none
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`, `i1`
+- **Arrays:** `oz(W)`
+- **Issues:** bandwidth bound
+- **Priority:** IMPORTANT
+
+### Loop: zran3 RNG fill at mg.c:1026
+- **Iterations:** `(e3-1)*(e2-1)` outer with inner `vranlc(d1)` (d1 elements)
+- **Type:** A — dense initialization with RNG; inner RNG loop is recurrence (Type E) inside `vranlc`
+- **Parent loop:** initialization block (not timed iteration)
+- **Contains:** call to `vranlc` (recurrence)
+- **Dependencies:** RNG recurrence inside `vranlc`
+- **Nested bounds:** constant
+- **Private vars:** `i3`, `i2`
+- **Arrays:** `oz(W)`
+- **Issues:** RNG recurrence; setup only
+- **Priority:** SECONDARY
+
+### Loop: power exponentiation at mg.c:1173
+- **Iterations:** while over bits of exponent `n` (log2(nx*ny*...))
+- **Type:** E — loop-carried state via `randlc`
+- **Parent loop:** none
+- **Contains:** none
+- **Dependencies:** RNG recurrence
+- **Nested bounds:** variable
+- **Private vars:** `nj`, `aj`
+- **Arrays:** none
+- **Issues:** sequential; setup-only
+- **Priority:** SECONDARY
+
+## Summary Table
+| Function | Type | Priority | Parent | Iterations | Dependencies | Issues |
+|----------|------|----------|--------|------------|--------------|--------|
+| main (it loop) | A | CRITICAL | none | `nit` | none | driver only |
+| mg3P level down (mg.c:344) | C2 | CRITICAL | main it | `lt-lb` | stage order | multigrid traversal |
+| mg3P mid levels (mg.c:355) | C2 | CRITICAL | main it | `lt-lb-1` | stage order | multiple kernels/level |
+| psinv stencil (mg.c:389/401) | G | CRITICAL | mg3P level | `(n3-2)*(n2-2)*n1` etc | none | halo after |
+| resid stencil (mg.c:459/473) | G | CRITICAL | mg3P level & main resid | `(n3-2)*(n2-2)*n1` etc | none | halo after |
+| rprj3 stencil (mg.c:546/561) | G | IMPORTANT | mg3P down | coarse-grid volume | none | scratch alloc |
+| interp stencil (mg.c:632–821) | G | CRITICAL/IMPORTANT (fallback) | mg3P up | fine-grid volume | none | overlapping writes |
+| comm3 halos (mg.c:913/921/929) | A | IMPORTANT | stencil kernels | surface sizes | order after compute | boundary copy |
+| norm2u3 reduction (mg.c:881) | F | SECONDARY | none | interior volume | reduction on `s/temp` | not per iter |
+| zero3 fill (mg.c:1242) | A | IMPORTANT | mg3P/setup | full grid | none | bandwidth bound |
+| zran3 RNG (mg.c:1026) | A/E | SECONDARY | init | `(e3-1)*(e2-1)*d1` | RNG recurrence | setup only |
+| power (mg.c:1173) | E | SECONDARY | init | O(log n) | RNG recurrence | sequential |
+
+## Data Details
+- **Dominant compute loop:** `for (it=1; it<=nit; ++it)` in `main`, executing `mg3P` V-cycle (restriction → smoothing → prolongation) plus `resid` per timestep.
+- **Arrays swapped between functions?:** NO; `u`, `v`, `r` are static 1D grids indexed via `I3D`; temporaries (`r1/r2`, `u1/u2`, `x1/y1`, `z1/z2/z3`) are allocated per kernel call, not swapped.
+- **Scratch arrays?:** YES; each stencil kernel allocates local work arrays (`r1/r2`, `u1/u2`, `x1/y1`, `z1/z2/z3`) sized to the active grid.
+- **Mid-computation sync?:** NO explicit barriers; `comm3` performs halo copies after stencil updates to refresh ghost cells.
+- **RNG in timed loop?:** NO; RNG (`zran3`, `power`, `randlc/vranlc`) occurs during setup (T_init) only.

tokens used
68,189